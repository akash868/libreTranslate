name: Deploy LibreTranslate to AWS Lambda

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  IMAGE_TAG: latest

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ===========================================================
      # NEW STEP â†’ ENSURE ECR REPOSITORY EXISTS
      # ===========================================================
      - name: Ensure ECR repository exists
        shell: bash
        run: |
          REPO="${{ secrets.ECR_REPO_NAME }}"
          REGION="${{ secrets.AWS_REGION }}"
          echo "Checking if ECR repo $REPO exists in $REGION..."

          if aws ecr describe-repositories --repository-names "$REPO" --region "$REGION" >/dev/null 2>&1; then
            echo "ECR repo exists: $REPO"
          else
            echo "ECR repo does NOT exist. Creating now..."
            aws ecr create-repository --repository-name "$REPO" --region "$REGION"
          fi

      - name: Build Docker image
        run: |
          docker build -t ${{ secrets.ECR_REPO_NAME }}:${IMAGE_TAG} -f Dockerfile.lambda .

      - name: Push Docker image
        run: |
          ECR_URI="${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPO_NAME }}:${IMAGE_TAG}"
          docker tag ${{ secrets.ECR_REPO_NAME }}:${IMAGE_TAG} $ECR_URI
          docker push $ECR_URI
          echo "ECR_URI=$ECR_URI" >> $GITHUB_ENV

      - name: Use existing S3 bucket
        run: |
          echo "Using existing bucket: ${{ secrets.MODEL_BUCKET }}"
          echo "BUCKET_NAME=${{ secrets.MODEL_BUCKET }}" >> $GITHUB_ENV
          echo "MODEL_KEY=${{ secrets.MODEL_S3_KEY }}" >> $GITHUB_ENV

      - name: Validate model exists in S3
        run: |
          echo "Checking S3 model file..."
          if aws s3 ls "s3://${{ secrets.MODEL_BUCKET }}/${{ secrets.MODEL_S3_KEY }}" >/dev/null; then
            echo "Model found successfully in S3."
          else
            echo "ERROR: Model NOT found in S3:"
            echo "Expected: s3://${{ secrets.MODEL_BUCKET }}/${{ secrets.MODEL_S3_KEY }}"
            exit 1
          fi

      - name: Deploy CloudFormation
        run: |
          aws cloudformation deploy \
            --stack-name "${{ secrets.STACK_NAME }}" \
            --template-file deploy.yml \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameter-overrides \
              RepositoryName="${{ secrets.ECR_REPO_NAME }}" \
              ImageTag="${IMAGE_TAG}" \
              ModelBucketName="${{ secrets.MODEL_BUCKET }}" \
              ModelObjectKey="${{ secrets.MODEL_S3_KEY }}"

      - name: Output Lambda URL
        run: |
          FUNCTION_NAME=$(aws cloudformation describe-stacks \
            --stack-name "${{ secrets.STACK_NAME }}" \
            --query "Stacks[0].Outputs[?OutputKey=='LambdaFunctionName'].OutputValue" \
            --output text)

          echo "Lambda Function Name: $FUNCTION_NAME"

          aws lambda create-function-url-config \
            --function-name "$FUNCTION_NAME" \
            --auth-type NONE >/dev/null 2>&1 || true

          URL=$(aws lambda get-function-url-config \
            --function-name "$FUNCTION_NAME" \
            --query FunctionUrl --output text)

          echo "Function URL: $URL"
